{% extends "contests/includes/base.html" %}

{% block title %}
    Create Project
{% endblock title %}


{% block content %}
    {% load bootstrap4 %}
    <div class=" card col-md-6 col-md-offset-3 container shadow">
    <br>    
    <div class="row">
    <h1 class="col-md-8">Create a Project</h1>
    <div class="col-md-4">
    
<form id="create-project-form" method="POST" enctype="multipart/form-data">
    <input type="button" class="btn btn-primary float-right" formaction="{% url 'projects:save_as_draft' %}" value="Save As Draft" onclick="saveDraft()"></input>
    </div>
        </div>
        <br>{% csrf_token %}
    {% bootstrap_form form %}
    {% buttons %}
    <br>
    <center>
            <h4>Total: GHS <span id="totalCost">0</span>.00</h4>
        </center>
        <br>
    <div class="row">
            <div class="col-md-6">
                <input type="button" class="btn btn-primary btn-block" formaction="{% url 'projects:save_as_draft' %}" value="Save As Draft" onclick="saveDraft()"></input>
            </div>
            <div class="col-md-6">
                <button type="button" class="btn btn-warning btn-block"  onclick="populate_verify_modal()">Submit</button>
            </div>
    </div>
    <br>
    {% endbuttons %}



      <!-- Modal -->
      <div class="modal fade" id="verify-project"  role="dialog" aria-labelledby="exampleModalLongTitle" aria-hidden="true"><br><br>
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h3 class="modal-title" id="exampleModalLongTitle"><center>Verify your project details before payment</center></h3>
              <button type="button" class="close " data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6"><h5>Title: </h5></div>
                    <div class="col-md-6"><span id="title"></span></div>
                </div>
                <div class="row">
                    <div class="col-md-6"><h5>Category: </h5></div>
                    <div class="col-md-6"><span id="cat"></span></div>
                </div>
                    <div class="row">
                        <div class="col-md-6"><h5>Description: </h5></div>
                        <div class="col-md-6"><span id="desc"></span></div>
                    </div>
                    <div class="row">
                        <div class="col-md-6"><h5>Files: </h5></div>
                        <div class="col-md-6"><span id="file"></span></div>
                    </div>
                    <div class="row">
                        <div class="col-md-6"><h5>Total Cost: </h5></div>
                        <div class="col-md-6"><span id="cost"></span></div>
                    </div>
                    <div class="row">
                        <div class="col-md-6"><h5>Needed by: </h5></div>
                        <div class="col-md-6"><span id="date"></span></div>
                    </div>
                    
                
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary btn-block" data-dismiss="modal">Cancel</button>
              <input type="submit" class="btn btn-warning btn-block"></button>
            </div>
          </div>
        </div>
      </div>

    </form>

    <script
    src="https://code.jquery.com/jquery-3.2.1.min.js"
    integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
    crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js" integrity="sha384-h0AbiXch4ZDo7tp9hKZ4TsHbi047NrKGLO3SEJAg45jXxnGIfYzk4Si90RDIqNm1" crossorigin="anonymous"></script>
    
    <script>
        var category_costs = "{{ category_prices }}";
        //replacing "&quot;" with "", to make valid json
        category_costs = JSON.parse(category_costs.replace(/&quot;/g, '"'));


        function populate_verify_modal(){
            
            //fetching values from the form
            var current_cost = $("#totalCost").text();
            var current_title = $("#id_title").val();
            var current_category = $("#id_category option:selected").text();
            var current_desc = $("#id_description").val();
            var current_end_date = $("#id_end_date").val();

            //populating modal with values
            $("#title").text(current_title);
            $("#cat").text(current_category);
            $("#desc").text(current_desc);
            //$("#file").text();
            $("#cost").text(current_cost);
            $("#date").text(current_end_date);

            //display modal
            $("#verify-project").modal('show');
        }


        function findCategoryPrice(category_id){
            var price = 0;
            $.each(category_costs, function(){
                if(this.id==category_id){
                    price = this.prize_lower_limit;
                }
            });
            return price;
        }
    
        $("#id_category").change(
            function(){
                newCategory = $("select option:selected").val();
                newCategoryPrize = findCategoryPrice(newCategory);
                $("#totalCost ").text(newCategoryPrize);
            }
        );

        function saveDraft() {
                var url = "{% url 'projects:save_as_draft' %}"; // the script where you handle the form input.
                $.ajax({
                       type: "POST",
                       url: url,
                       data: $("#create-project-form").serialize(), // serializes the form's elements.
                       success: function(data){
                           alert(data); // show response from the view
                           window.location.href="{% url 'dashboard' %}";
                       }
                });
        }

    </script>
{% endblock content %}